<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>Timer</title>
  <link rel="icon" href="img/favicon.ico">
  <link rel="stylesheet" href="css/bootstrap.css">
  <link rel="stylesheet" href="css/font-awesome.css">
</head>
<body>
<div class="container">
<!--   <timer name="Chapter 1 - Light World"></timer>
  <hr>
  <timer name="Chapter 2 - Light World"></timer>
  <hr>
  <timer name="Chapter 3 - Light World"></timer>
 -->
  <alltimer></alltimer>
</div>

<!-- include extern librarys -->
<script src="js/superagent.js"></script>
<script src="js/localforage.min.js"></script>
<script src="js/riotux.js"></script>
<script src="js/riotrage.js"></script>

<!-- include components -->
<script src="components/timer.tag" type="riot/tag"></script>
<script src="components/allTimer.tag" type="riot/tag"></script>

<!-- include riot.js and the compiler -->
<script src="js/riot+compiler.js"></script>

<script type="text/javascript">
  riot.mount('*');
  
  const defaultTimerList = {
    theme: "SuperMeatBoy",
    timerList: [
      {id:'smbc1lw',name:'Chapter 1 - Light World',time:0,best:24143423},
      {id:'smbc1dw',name:'Chapter 1 - Dark World',time:0,best:24143423},
      {id:'smbc2lw',name:'Chapter 2 - Light World',time:0,best:24143423},
      {id:'smbc2dw',name:'Chapter 2 - Dark World',time:0,best:24143423},
      {id:'smbc3lw',name:'Chapter 3 - Light World',time:0,best:24143423},
      {id:'smbc3dw',name:'Chapter 3 - Dark World',time:0,best:24143423},
      {id:'smbc4lw',name:'Chapter 4 - Light World',time:0,best:24143423},
      {id:'smbc4dw',name:'Chapter 4 - Dark World',time:0,best:24143423},
    ]
  };

  let store = riotux.Store({
    state: {
      theme: 'SuperMeatBoy',
      allTime: 0,
      timerList: [],
      listOfTimes: {}
    },
    mutations: {
      loadTimerList: (state, themeName) => {
        let fromLocal = (themeName||false)? JSON.parse(localStorage.getItem(themeName)) : defaultTimerList;
        state.allTime = 0;
        state.theme = fromLocal.theme;
        state.timerList = fromLocal.timerList;
      },
      saveTimerList: (state) => {
        let toLocal = JSON.stringify({theme:state.theme,timerList:state.timerList});
        localStorage.setItem(state.theme,toLocal);
      },
      updateById: (state, id, upObj) => {
        for(let s in state.timerList) {
          if(state.timerList[s].id===id) {
            for(let u in upObj) {
              state.timerList[s][u] = upObj[u];
            }
            break;
          }
        }
      },
      addAllTime: (state,timeToAdd) => {
        state.allTime+= timeToAdd;
      },
      moveUpInList: (state, id) => {
        let index = state.timerList.map( e => { return e.id } ).indexOf(id);
        if(index<=0) {
          return (index===-1)? 'index not found' : 'index to low';
        }
        state.timerList.splice(index, 0, state.timerList.splice(index-1,1)[0]);
      },
      moveDownInList: (state, id) => {
        let index = state.timerList.map( e => { return e.id } ).indexOf(id);
        if(index===state.timerList.length-1) {
          return 'index to high';
        }
        state.timerList.splice(index+1, 0, state.timerList.splice(index,1)[0]);        
      },
      moveInList: (state, id, dir) => {
        let index = state.timerList.map( e => { return e.id } ).indexOf(id);
        if(index===-1) {
          return "index not found";
        } else if(index===0&&dir==="UP") {
          return "index to low";
        } else if(index===state.timerList.length-1&&dir==="DOWN") {
          return "index to high";
        }
        let to = (dir==="UP")? index-1 : index+1;
        state.timerList.splice(to, 0, state.timerList.splice(index,1)[0]);
      },
      updateTimeOfItem: (state, id, time) => {
        let rawLocal = localStorage.getItem(id)||'{}';
        let fromLocal = (rawLocal||false)? JSON.parse(rawLocal) : {};
        fromLocal[Date.now()] = time;
        state.listOfTimes[id] = fromLocal;
        let toLocal = JSON.stringify(fromLocal);
        localStorage.setItem(id, toLocal);
      },
      loadTimeOfItem: (state,id) => {
        if(!(state.listOfTimes[id]||false)) {
          let rawLocal = localStorage.getItem(id)||'{}';
          let fromLocal = (rawLocal||false)? JSON.parse(rawLocal) : {};
          state.listOfTimes[id] = fromLocal;
        }
        return state.listOfTimes[id];
      }
    }
  });


  let action = riotux.Actions({
    loadAll: (store, name) => {
      store.dispatch('loadTimerList', name);
    },
    saveAll: (store) => {
      store.dispatch('saveTimerList');
    },
    updateTimer: (store, id, updateObj) => {
      store.dispatch('updateById', id, updateObj);
    },
    moveItemUp: (store, id) => {
      return store.dispatch('moveInList', id, "UP");
    },
    moveItemDown: (store, id) => {
      return store.dispatch('moveInList', id, "DOWN");
    },
    updateTime: (store, id, time) => {
      store.dispatch('updateTimeOfItem', id, time);
    },
    loadTime: (store, id) => {
      return store.dispatch('loadTimeOfItem', id);
    }
    // getList: ( store, state ) => {
    //   if(state===undefined) return;
    //   let baseString = (state.search.base||false)? state.search.base : '';
    //   let searchText = encodeURIComponent(baseString + state.search.text);
    //   let urlString = '/search/key/'+state.search.limit+'/'+searchText;
    //   superagent('get',urlString).then( (res) => {
    //     store.dispatch('setKVlist', res.body);
    //     console.log("read kvlist done !!!");
    //   });
    // },
    // getBaseList: (store, state, searchString) => {
    //   let urlString = '/search/key/'+state.search.limit+'/'+encodeURIComponent(searchString);
    //   superagent('get',urlString).then( (res) => {
    //     store.dispatch('setBaseListMatrix', res.body);
    //   });
    // }
  });
  // riotux.action('timerList', 'saveAll');
  // riotux.action('timerList', 'updateTimer', 'smbc3lw', {best:64223});
  // riotux.action('listOfTimes', 'updateTime', id, time);
  riotux.action('timerList', 'loadAll', 'SuperMeatBoy');

</script>
</body>
</html>